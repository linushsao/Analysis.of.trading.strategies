6rm(list = ls())

LIBRS <- c('quantmod','stringr','fTrading','xts','TTR','roxygen2')
sapply(LIBRS,library,character.only=TRUE)

#local devel fubction
setwd("/home/linus/ProjectStock/ExtraPackages/linus/stock.Analyze")
roxygenize()
library("stock.Analyze")

setwd("/home/linus/ProjectStock/all_stocks/")

#CONFIG
all.code.List <- env(name="all.code.List",mode="r")
prefix.stock.extension <- env(name="prefix.stock.extension",mode="r")
prefix.raw.data.name <- env(name="prefix.raw.data.name",mode="r")
raw.data.Listname <- env(name="raw.data.Listname",mode="r")
stock.selected_Files <- c("2019-01-01::2019-04-30","2019-08-01::2019-12-31","2019","2018","2017")

raw.data.List <- c()

if( length(stock.selected_Files) != 0) { #reset raw.data.Listname
    env(name="raw.data.Listname",value=raw.data.Listname,mode="w")
    write.csv(stock.selected_Files,file=raw.data.Listname)
    }
stock.selected_Files <- as.vector(read.csv(raw.data.Listname , header=TRUE, sep=",")[,2])

# main function

# be_replace <- c("[Washed]_1_","_ANALYZE.csv")
# patten <- c("")
# stock.selected_Files <- m_gsub(,.r[2:length(.r)])

#
stock_ignore <- c("1729","2025","2384","6131","6205","8201","9106") #忽略不計的股票編號
safe_rate <- 0.015 #無風險投資報酬率,此為定存利率

#讀入所有股票的編號
m_data1 <- read.csv(all.code.List, header=TRUE, sep=",")
#m_data2 <- as.data.frame(c('0050','0056'))
#names(m_data2) <- 'STOCK_CODE'

#m_data <- rbind(m_data1,m_data2)
m_data <- m_data1

#head(m_data1)
#head(m_data2)
#head(m_data)
#tail(m_data)

name <- paste(m_data[,1],prefix.stock.extension, sep = "") 
name_c <- as.vector(m_data[,2])
name_group <- as.vector(m_data[,5])
name_type <- as.vector(m_data[,6])
#head(name)
#tail(name)
#write.zoo(name,file="temp.csv",sep=",")

#for test
#for(i in 1:length(name)) {
#  name[i]-> symbol
#  file_name <- paste(symbol,"csv", sep = ".") 	
#  write.table(c(1:10), file = file_name, sep = ",")
#}
for( range in 1:length(stock.selected_Files) )  {
    selected_period <- stock.selected_Files[range]
    KK_RAW <- c()
    
    for(i in 1:length(name)) {
        name[i]-> symbol
        file_name <- paste(symbol,"csv", sep = ".") 	
        tryit <- try(read.csv(file_name,header=TRUE))
        
        if(inherits(tryit, "try-error") | (gsub(prefix.stock.extension,"",symbol) %in% stock_ignore) ){
            i <- i+1
        } else {
            data_RAW <- read.csv(file_name,header=TRUE)
            data <- na.omit(xts(data_RAW[c(2:7)],order.by=as.Date(data_RAW$Index)))
            names(data) <- c("Open","High","Low","Close","Volume","Adjusted")
            
            l <- length(data[selected_period])
            if( l == 0 ){
            i <- i+1
            } else {
            data_1 <- data[selected_period]
            return_1 <- na.omit(ROC(data_1$Close))
            return <- exp(cumsum(return_1))
            mdd = maxDrawDown(cumsum(return_1))
            l <- length(return)

            temp <- c(symbol,name_c[i],data_1$Close[l],return$Close[l],name_type[i],name_group[i],mdd$maxdrawdow,((return$Close[l]-1-safe_rate)/mdd$maxdrawdown))
            KK_RAW <- rbind(KK_RAW,temp)
            }
        }
    }

    raw.data.List[range] <- m_paste(c(prefix.raw.data.name,selected_period,".csv"),op="")
    names(KK_RAW) <- c("INDEX","STOCK_CODE","STOCK_NAME","LAST_CLOSE","RATE","GROUP","TYPE","MaxDrawDOWN","SHARP_RATIO")
    write.zoo(KK_RAW,file= raw.data.List[range],sep=",")
    #View(KK_RAW)
}

#save raw file list
write.csv(raw.data.List,file=raw.data.Listname)




